<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HTML Fetch Tool</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Prism.js -->
<link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">

<style>
body {
  font-family: system-ui, sans-serif;
  background: linear-gradient(135deg, #667eea, #764ba2);
  padding: 30px;
}

.container {
  max-width: 900px;
  margin: auto;
  background: #fff;
  padding: 25px;
  border-radius: 12px;
}

.selector-row {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

input {
  flex: 1;
  padding: 12px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.add-btn {
  padding: 12px 16px;
  background: #667eea;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.fetch-btn {
  margin-top: 15px;
  width: 100%;
  padding: 14px;
  background: #764ba2;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

.result-block {
  background: #1e1e1e;
  margin-top: 25px;
  padding: 15px;
  border-radius: 10px;
}

.result-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
}

.result-header span {
  color: #9cdcfe;
  font-weight: bold;
}

.copy-btn {
  background: #0d6efd;
  color: #fff;
  border: none;
  padding: 6px 14px;
  border-radius: 6px;
  cursor: pointer;
}

pre {
  margin: 0;
  max-height: 500px;
  overflow: auto;
  border-radius: 8px;
}
</style>
</head>

<body>

<div class="container">
  <input id="url" placeholder="Enter webpage URL">

  <div id="selectors">
    <div class="selector-row">
      <input placeholder=".class or #id">
      <button class="add-btn" onclick="addSelector()">+</button>
    </div>
  </div>

  <button class="fetch-btn" onclick="fetchContent()">Fetch HTML</button>

  <div id="results"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markup.min.js"></script>

<script>
function addSelector() {
  const row = document.createElement('div');
  row.className = 'selector-row';
  row.innerHTML = `
    <input placeholder=".class or #id">
    <button class="add-btn" onclick="this.parentElement.remove()">âˆ’</button>
  `;
  document.getElementById('selectors').appendChild(row);
}

async function fetchContent() {
  const url = document.getElementById('url').value.trim();
  const selectors = [...document.querySelectorAll('#selectors input')]
    .map(i => i.value.trim())
    .filter(Boolean);

  const res = await fetch('/api/fetch', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ url, selectors })
  });

  const data = await res.json();
  renderResults(data);
}

/* Beautify HTML */
function formatHTML(html) {
  const tab = '  ';
  let formatted = '';
  let indent = 0;

  html.replace(/>(<)/g, '>\n<').split('\n').forEach(line => {
    if (line.match(/^<\/\w/)) indent--;
    formatted += tab.repeat(indent) + line + '\n';
    if (line.match(/^<\w[^>]*[^\/]>$/)) indent++;
  });

  return formatted.trim();
}

function escapeHTML(str) {
  return str.replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
}

function renderResults(data) {
  const results = document.getElementById('results');
  results.innerHTML = '';

  data.forEach(item => {
    const block = document.createElement('div');
    block.className = 'result-block';

    const prettyHTML = formatHTML(item.content || 'Not Found');
    const escaped = escapeHTML(prettyHTML);

    block.innerHTML = `
      <div class="result-header">
        <span>${item.selector}</span>
        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
      </div>
      <pre><code class="language-html">${escaped}</code></pre>
    `;

    results.appendChild(block);
  });

  Prism.highlightAll();
}

function copyCode(btn) {
  const code = btn.closest('.result-block').querySelector('code').innerText;
  navigator.clipboard.writeText(code);
}
</script>

</body>
</html>
